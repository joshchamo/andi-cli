<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ANDI Scan Report – {{summary.runId}}</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 24px;
      /* Dark Theme */
      background: #121212;
      color: #e0e0e0;
      line-height: 1.5;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 { margin-bottom: 4px; color: #fff; }
    h2 { margin-top: 32px; color: #fff; }

    a { color: #58a6ff; }
    a:visited { color: #8e95ea; }

    .card {
      /* Dark Theme */
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 18px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
      margin-bottom: 18px;
    }

    .meta-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .badge {
      padding: 3px 6px;
      border-radius: 4px;
      font-size: .75rem;
      font-weight: 600;
      text-transform: uppercase;
      color: #000; /* Ensure text is readable on colored badges */
    }

    .danger { background: #ff8e67; }
    .warning { background: #ffb74b; }
    .caution { background: #ffee7e; }

    /* ANDI Output Styling */
    #ANDI508-outputText {
      background: #000;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
      margin-top: 5px;
      font-family: monospace;
      border: 1px solid #444;
    }

    /* Force block display for new lines */
    .ANDI508-display-ariaLabel,
    .ANDI508-display-ariaLabelledby,
    .ANDI508-display-ariaDescription, 
    .ANDI508-display-ariaDescribedby,
    .ANDI508-display-innerText,
    .ANDI508-display-danger,
    .ANDI508-display-warning,
    .ANDI508-display-caution {
      display: block;
      margin-bottom: 2px;
    }

    /* ANDI Colors */
    .ANDI508-display-ariaLabel { color: #62ff8f !important; }
    .ANDI508-display-ariaLabelledby { color: #00e741 !important; }
    .ANDI508-display-ariaDescribedby { color: #12c8f1 !important; }
    .ANDI508-display-ariaDescription { color: #57F9FF !important; }
    .ANDI508-display-innerText { color: #d6ffe1 !important; }
    .ANDI508-display-danger { color: #ff8e67 !important; }
    .ANDI508-display-warning { color: #ffb74b !important; }
    .ANDI508-display-caution { color: #ffee7e !important; }

    /* Ensure links inside alerts inherit the severity color */
    .ANDI508-display-danger a,
    .ANDI508-display-warning a,
    .ANDI508-display-caution a {
      color: inherit !important;
      text-decoration: underline;
    }

    /* Clean up ANDI images in output if copied */
    #ANDI508-outputText img { display: none; }

    .table-scroll-wrapper {
      overflow-x: auto;
      /* Ensure scrollbar is always accessible if content overflows */
      width: 100%;
    }

    table {
      width: 100%; 
      /* Force table to be wide enough to require scrolling */
      min-width: 1800px; 
      border-collapse: collapse;
      margin-top: 12px;
      background: #1e1e1e;
      color: #e0e0e0;
      table-layout: fixed;
    }

    /* Column Widths */
    th:nth-child(1) { width: 100px; }  /* Severity */
    th:nth-child(2) { width: 120px; }  /* Module */
    th:nth-child(3) { width: 300px; }  /* Alert */
    th:nth-child(4) { width: 700px; }  /* ANDI Output (Doubled+) */
    th:nth-child(5) { width: auto; }   /* Element (Pushed right) */

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      text-align: left;
      vertical-align: top;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }

    th { 
      background: #252526; 
      color: #fff;
    }

    code {
      background: #2d2d2d;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #444;
      display: inline-block;
      color: #e6e6e6;
    }

    pre {
      overflow-x: auto;
      background: #2d2d2d;
      padding: 10px;
      border-radius: 6px;
      font-size: .9rem;
      color: #e6e6e6;
    }

    .detail {
      margin-top: 6px;
      font-size: .9rem;
      word-break: break-word;
    }

    .muted { color: #aaa; }

    .small { font-size: .85rem; }

    /* New styles for copyable code blocks */
    .code-block-wrapper {
      position: relative;
      background: #2d2d2d;
      border-radius: 6px;
      margin-top: 8px;
      border: 1px solid #444;
    }

    .code-block-wrapper pre {
      margin: 0;
      padding: 12px;
      padding-top: 36px; /* Space for button */
      background: transparent; /* Wrapper handles bg */
      border: none;
      border-radius: 0;
      white-space: pre-wrap;
      word-break: break-all;
      color: #e6e6e6;
    }
    
    .code-block-wrapper .code-content {
      /* Container for pre to handle height properly */
    }

    .copy-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: #444;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      color: #fff;
      transition: all 0.2s;
      z-index: 10;
    }

    .copy-btn:hover {
      background: #505050;
      border-color: #666;
    }

    /* Expandable Code Blocks */
    .code-block-wrapper.collapsed pre {
      max-height: 160px; /* Show roughly 8-10 lines */
      overflow: hidden;
      mask-image: linear-gradient(180deg, black 60%, transparent);
      -webkit-mask-image: linear-gradient(180deg, black 60%, transparent);
    }
    
    .expand-btn {
      display: none;
      width: 100%;
      text-align: center;
      background: #252526;
      border: none;
      border-top: 1px solid #444;
      padding: 6px;
      font-size: 0.8rem;
      color: #58a6ff;
      cursor: pointer;
      border-radius: 0 0 6px 6px;
    }

    .code-block-wrapper.collapsed .expand-btn {
      display: block;
    }

    /* Sortable Headers */
    th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 24px;
    }
    th.sortable:hover {
      background: #333;
    }
    th.sortable::after {
      content: '↕';
      position: absolute;
      right: 8px;
      color: #666;
      font-size: 0.8rem;
    }
    th.sorted-asc::after { content: '↑'; color: #fff; }
    th.sorted-desc::after { content: '↓'; color: #fff; }

    /* Alert Collapsibility */
    .alert-details-wrapper.collapsed #ANDI508-outputContainer {
      display: none;
    }
    
    .alert-toggle-btn {
      background: none;
      border: 1px solid #444;
      color: #58a6ff;
      border-radius: 4px;
      font-size: 0.75rem;
      padding: 2px 8px;
      cursor: pointer;
      margin-left: 8px;
      white-space: nowrap;
    }
    .alert-toggle-btn:hover { background: #333; }
    
    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 4px;
    }

    /* Links List Table */
    .links-details {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 10px;
      margin-bottom: 24px;
      overflow: hidden;
    }
    .links-details summary {
      background: #252526;
      padding: 15px 20px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      outline: none;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .links-details summary:hover {
      background: #333;
    }
    .links-details[open] summary {
      border-bottom: 1px solid #444;
    }
    .links-content {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }
    .links-table {
      margin-top: 0;
    }
    .links-table th { position: sticky; top: 0; z-index: 10; }

    .copy-btn-static {
      background: #444;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      color: #fff;
      margin-left: 10px;
    }
    .copy-btn-static:hover {
      background: #505050;
    }

  </style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="card">
    <h1>ANDI Scan Report</h1>

    <div class="meta-grid small">
      <div><strong>Run ID:</strong> {{summary.runId}}</div>
      <div><strong>URL:</strong> <a href="{{summary.url}}" target="_blank">{{summary.url}}</a></div>
      <div><strong>Timestamp:</strong> {{summary.timestamp}}</div>
      <div><strong>Browser:</strong> {{summary.browserUsed}}</div>
    </div>

    <hr>

    <div class="small">
      <strong>Total Alerts:</strong> {{summary.totalAlerts}}
      &nbsp;&nbsp;
      <span class="badge danger">Danger: {{summary.severityBreakdown.Danger}}</span>
      <span class="badge warning">Warning: {{summary.severityBreakdown.Warning}}</span>
      <span class="badge caution">Caution: {{summary.severityBreakdown.Caution}}</span>
    </div>
  </div>

  <!-- LINKS LIST TABLE -->
  {{#if summary.linksListTable}}
  <h2>Links List</h2>
  <details class="links-details" open>
    <summary>
      <span>Links Found: {{summary.linksListTable.length}} (Click to Toggle)</span>
      <button class="copy-btn-static" onclick="copyLinksTable(this, event)">Copy Table</button>
    </summary>
    <div class="links-content">
      <table id="links-table" class="links-table">
        <thead>
          <tr>
            <th style="width: 60px;">#</th>
            <th style="width: 200px;">Alerts</th>
            <th style="width: 30%;">Accessible Name</th>
            <th>Href</th>
          </tr>
        </thead>
        <tbody>
          {{#each summary.linksListTable}}
          <tr>
            <td>{{index}}</td>
            <td>
              {{#if alerts}}
                <span style="color: #ffb74b;">{{alerts}}</span>
              {{else}}
                <span class="muted">-</span>
              {{/if}}
            </td>
            <td>{{name}}</td>
            <td>
              {{#if href}}
                <a href="{{resolvedUrl}}" target="_blank"><code>{{href}}</code></a>
              {{else}}
                <span class="muted">-</span>
              {{/if}}
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </details>
  {{/if}}

  <!-- DETAILED ALERTS -->
  <h2>Detailed Alerts</h2>

  <div class="card">
   <div class="table-scroll-wrapper">
    <table id="alerts-table">
      <thead>
        <tr>
          <th class="sortable" onclick="sortTable('alerts-table', 0)">Severity</th>
          <th class="sortable" onclick="sortTable('alerts-table', 1)">Module</th>
          <th class="sortable" onclick="sortTable('alerts-table', 2)">Alert</th>
          <th class="sortable" onclick="sortTable('alerts-table', 3)">ANDI Output</th>
          <th class="sortable" onclick="sortTable('alerts-table', 4)">Element</th>
        </tr>
      </thead>

      <tbody>
      {{#each issues}}
        <tr>
          <td>
            <span class="badge
              {{#if (eq severity "Danger")}}danger{{/if}}
              {{#if (eq severity "Warning")}}warning{{/if}}
              {{#if (eq severity "Caution")}}caution{{/if}}">
              {{severity}}
            </span>
          </td>

          <td>{{andiModule}}</td>

          <td>
            <div class="alert-header">
              <div>{{alertMessage}}</div>
            </div>

            {{#if tt_mapping}}
              <div class="detail small">
                <strong>Trusted Tester Mapping:</strong> {{tt_mapping}}
              </div>
            {{/if}}
          </td>

          <td>
            {{#if alertDetails}}
              <div class="detail muted">{{{alertDetails}}}</div>
            {{else}}
              <span class="muted">-</span>
            {{/if}}
          </td>

          <td>
            <div><code>{{elementTag}}</code></div>

            {{#if elementId}}
              <div class="small muted">#{{elementId}}</div>
            {{/if}}

            {{#if elementSnippet}}
              <div class="code-block-wrapper">
                <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                <div class="code-content"><pre>{{elementSnippet}}</pre></div>
                <button class="expand-btn" onclick="toggleExpand(this)">Show more</button>
              </div>
            {{/if}}
          </td>
        </tr>
      {{/each}}
      </tbody>
    </table>
   </div>
  </div>

</div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize code blocks
      const wrappers = document.querySelectorAll('.code-block-wrapper');
      wrappers.forEach(wrapper => {
        const pre = wrapper.querySelector('pre');
        // Check if content height is significant (approx 160px is our collapsed height)
        if (pre.scrollHeight > 180) {
          wrapper.classList.add('collapsed');
        } else {
          // Hide expand button for short snippets
          const btn = wrapper.querySelector('.expand-btn');
          if(btn) btn.style.display = 'none';
        }
      });
    });

    function toggleExpand(btn) {
      const wrapper = btn.closest('.code-block-wrapper');
      wrapper.classList.toggle('collapsed');
      btn.innerText = wrapper.classList.contains('collapsed') ? 'Show more' : 'Show less';
    }

  function copyToClipboard(btn) {
    const wrapper = btn.closest('.code-block-wrapper');
    const codeBlock = wrapper.querySelector('pre'); 
    const text = codeBlock.innerText;

    navigator.clipboard.writeText(text).then(() => {
      const originalText = btn.innerText;
      btn.innerText = 'Copied!';
      btn.style.background = '#d4edda';
      btn.style.borderColor = '#c3e6cb';
      
      setTimeout(() => {
        btn.innerText = originalText;
        btn.style.background = '';
        btn.style.borderColor = '';
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy:', err);
      btn.innerText = 'Error';
    });
  }

  function copyLinksTable(btn, e) {
    if(e) e.stopPropagation();

    const table = document.getElementById('links-table');
    if (!table) return;

    let textToCopy = '';
    
    // Headers
    const headers = Array.from(table.querySelectorAll('th')).map(th => th.innerText.trim());
    textToCopy += headers.join('\t') + '\n';

    // Rows
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    rows.forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td'));
        const rowData = cells.map((td, index) => {
            // For the 'Href' column (index 3), try to get the actual link URL so it works in Excel
            if (index === 3) {
                const link = td.querySelector('a');
                if (link && link.href) {
                    return link.href;
                }
            }
            return td.innerText.trim().replace(/\n/g, ' ');
        });
        textToCopy += rowData.join('\t') + '\n';
    });

    navigator.clipboard.writeText(textToCopy).then(() => {
        const originalText = btn.innerText;
        btn.innerText = 'Copied!';
        btn.style.background = '#d4edda';
        btn.style.borderColor = '#c3e6cb';
        btn.style.color = '#155724';
        
        setTimeout(() => {
          btn.innerText = originalText;
          btn.style.background = '';
          btn.style.borderColor = '';
          btn.style.color = '';
        }, 2000);
    }).catch(err => {
      console.error('Failed to copy table:', err);
    });
  }

  // Sorting Logic
  function sortTable(tableId, n) {
    const table = document.getElementById(tableId);
    let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    switching = true;
    dir = "asc"; 
    
    // Reset arrows
    table.querySelectorAll("th").forEach(th => {
      th.classList.remove("sorted-asc", "sorted-desc");
    });
    
    // Set arrow for current header
    const headers = table.querySelectorAll("th");
    
    while (switching) {
      switching = false;
      rows = table.rows;
      
      // rows[0] is header, so start at 1
      for (i = 1; i < (rows.length - 1); i++) {
        shouldSwitch = false;
        x = rows[i].getElementsByTagName("TD")[n];
        y = rows[i + 1].getElementsByTagName("TD")[n];
        
        let xVal = x.textContent.trim().toLowerCase();
        let yVal = y.textContent.trim().toLowerCase();
        
        // Special weighting for Severity (Column 0)
        if (n === 0) {
           const severityWeight = { 'danger': 3, 'warning': 2, 'caution': 1 };
           xVal = severityWeight[xVal] || 0;
           yVal = severityWeight[yVal] || 0;
        }

        if (dir === "asc") {
          if (xVal > yVal) {
            shouldSwitch = true;
            break;
          }
        } else if (dir === "desc") {
          if (xVal < yVal) {
            shouldSwitch = true;
            break;
          }
        }
      }
      
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        switchcount ++;      
      } else {
        if (switchcount === 0 && dir === "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
    
    // Update header class
    headers[n].classList.add(dir === "asc" ? "sorted-asc" : "sorted-desc");
  }
</script>

</body>
</html>