<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ANDI Scan Report â€“ {{summary.runId}}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    {{{css}}}
  </style>
</head>

<body>
<div class="container">

  <header class="card" role="banner">
    <h1>ANDI Scan Report</h1>
    <div class="meta-grid">
      <div><strong>Run ID:</strong> {{summary.runId}}</div>
      <div><strong>URL:</strong> <a href="{{summary.url}}" target="_blank" rel="noopener">{{summary.url}}</a></div>
      <div><strong>Timestamp:</strong> {{summary.timestamp}}</div>
      <div><strong>Browser:</strong> {{summary.browserUsed}}</div>
    </div>
    <hr class="divider">
    <div class="summary-stats">
      <strong>Total Alerts:</strong> {{summary.totalAlerts}}
      &nbsp;&nbsp;
      <span class="badge danger">Danger: {{summary.severityBreakdown.Danger}}</span>
      <span class="badge warning">Warning: {{summary.severityBreakdown.Warning}}</span>
      <span class="badge caution">Caution: {{summary.severityBreakdown.Caution}}</span>
    </div>
  </header>

  {{#if summary.linksListTable}}
  <section aria-labelledby="links-heading">
    <h2 id="links-heading">Links List</h2>
    <details class="links-details" open>
      <summary>
        <span>Links Found: {{summary.linksListTable.length}} (Click to Toggle)</span>
        <button class="copy-btn-static" onclick="copyLinksTable(this, event)">Copy Table</button>
      </summary>
      <div class="table-scroll-wrapper">
        <table id="links-table">
          <thead>
            <tr>
              <th scope="col" style="width: 60px;">#</th>
              <th scope="col" style="width: 200px;">Alerts</th>
              <th scope="col">Accessible Name</th>
              <th scope="col">Href</th>
            </tr>
          </thead>
          <tbody>
            {{#each summary.linksListTable}}
            <tr>
              <td data-label="#">{{index}}</td>
              <td data-label="Alerts">
                {{#if alerts.length}}
                  {{#each alerts}}
                    <div class="andi-link-alert {{level}}">
                      {{#if url}}
                        <a href="{{url}}" target="_blank" rel="noopener">{{message}}</a>
                      {{else}}
                        <span>{{message}}</span>
                      {{/if}}
                    </div>
                  {{/each}}
                {{else}}
                  <span class="muted">-</span>
                {{/if}}
              </td>
              <td data-label="Accessible Name">{{name}}</td>
              <td data-label="Href">
                {{#if href}}
                  <a href="{{resolvedUrl}}" target="_blank" rel="noopener" class="href-link"><code>{{href}}</code></a>
                {{else}}
                  <span class="muted">-</span>
                {{/if}}
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </details>
  </section>
  {{/if}}

  <section aria-labelledby="alerts-heading">
    <h2 id="alerts-heading">Detailed Alerts</h2>
    <div class="table-scroll-wrapper">
      <table id="alerts-table">
        <thead>
          <tr>
            <th class="sortable" onclick="sortTable('alerts-table', 0)">Severity</th>
            <th class="sortable" onclick="sortTable('alerts-table', 1)">Module</th>
            <th class="sortable" onclick="sortTable('alerts-table', 2)">Alert</th>
            <th class="sortable" onclick="sortTable('alerts-table', 3)">ANDI Output</th>
            <th class="sortable" onclick="sortTable('alerts-table', 4)">Element</th>
          </tr>
        </thead>
        <tbody>
          {{#each issues}}
          <tr>
            <td data-label="Severity">
              <span class="badge 
                {{#if (eq severity "Danger")}}danger{{/if}}
                {{#if (eq severity "Warning")}}warning{{/if}}
                {{#if (eq severity "Caution")}}caution{{/if}}">
                {{severity}}
              </span>
            </td>
            <td data-label="Module">{{andiModule}}</td>
            <td data-label="Alert">
              <div class="alert-header">{{alertMessage}}</div>
              {{#if tt_mapping}}
                <div class="detail small"><strong>Trusted Tester:</strong> {{tt_mapping}}</div>
              {{/if}}
            </td>
            <td data-label="ANDI Output">
              {{#if alertDetails}}
                <div class="detail muted">{{{alertDetails}}}</div>
              {{else}}
                <span class="muted">-</span>
              {{/if}}
            </td>
            <td data-label="Element">
              <div><code>{{elementTag}}</code></div>
              {{#if elementId}}<div class="small muted">#{{elementId}}</div>{{/if}}
              
              {{#if screenshotData}}
                <div>
                  <a href="data:image/png;base64,{{screenshotData}}" target="_blank" class="screenshot-link">
                    Screenshot of affected element
                  </a>
                </div>
              {{else}}
                {{#if screenshotPath}}
                  <div>
                    <a href="{{screenshotPath}}" target="_blank" class="screenshot-link">
                      Screenshot of affected element
                    </a>
                  </div>
                {{/if}}
              {{/if}}

              {{#if bestSelector}}
                <div class="code-block-wrapper">
                  <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                  <div class="code-content"><pre>{{bestSelector}}</pre></div>
                  <button class="expand-btn" onclick="toggleExpand(this)">Show more</button>
                </div>
              {{else}}
                {{#if elementSnippet}}
                  <div class="code-block-wrapper">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                    <div class="code-content"><pre>{{elementSnippet}}</pre></div>
                    <button class="expand-btn" onclick="toggleExpand(this)">Show more</button>
                  </div>
                {{/if}}
              {{/if}}
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </section>

</div>

<script>
  // Preservation of all original script logic (Sort, Copy, Expand)
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.code-block-wrapper').forEach(wrapper => {
      const pre = wrapper.querySelector('pre');
      if (pre.scrollHeight > 180) wrapper.classList.add('collapsed');
      else { const btn = wrapper.querySelector('.expand-btn'); if(btn) btn.style.display = 'none'; }
    });
  });

  function toggleExpand(btn) {
    const wrapper = btn.closest('.code-block-wrapper');
    wrapper.classList.toggle('collapsed');
    btn.innerText = wrapper.classList.contains('collapsed') ? 'Show more' : 'Show less';
  }

  function copyToClipboard(btn) {
    const text = btn.closest('.code-block-wrapper').querySelector('pre').innerText;
    navigator.clipboard.writeText(text).then(() => {
      const original = btn.innerText;
      btn.innerText = 'Copied!';
      setTimeout(() => btn.innerText = original, 2000);
    });
  }

  function sortTable(tableId, n) {
    const table = document.getElementById(tableId);
    let rows, switching = true, i, x, y, shouldSwitch, dir = "asc", switchcount = 0;
    table.querySelectorAll("th").forEach(th => th.classList.remove("sorted-asc", "sorted-desc"));
    while (switching) {
      switching = false; rows = table.rows;
      for (i = 1; i < (rows.length - 1); i++) {
        shouldSwitch = false;
        x = rows[i].getElementsByTagName("TD")[n];
        y = rows[i + 1].getElementsByTagName("TD")[n];
        let xV = x.textContent.trim().toLowerCase(), yV = y.textContent.trim().toLowerCase();
        if (n === 0) {
          const weight = { 'danger': 3, 'warning': 2, 'caution': 1 };
          xV = weight[xV] || 0; yV = weight[yV] || 0;
        }
        if ((dir === "asc" && xV > yV) || (dir === "desc" && xV < yV)) { shouldSwitch = true; break; }
      }
      if (shouldSwitch) { rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); switching = true; switchcount++; }
      else if (switchcount === 0 && dir === "asc") { dir = "desc"; switching = true; }
    }
    table.querySelectorAll("th")[n].classList.add(dir === "asc" ? "sorted-asc" : "sorted-desc");
  }

  function copyLinksTable(btn, e) {
    if(e) e.stopPropagation();
    const table = document.getElementById('links-table');
    let text = Array.from(table.querySelectorAll('th')).map(th => th.innerText.trim()).join('\t') + '\n';
    table.querySelectorAll('tbody tr').forEach(tr => {
      text += Array.from(tr.querySelectorAll('td')).map((td, i) => {
        if (i === 3) { const a = td.querySelector('a'); if (a) return a.href; }
        return td.innerText.trim().replace(/\n/g, ' ');
      }).join('\t') + '\n';
    });
    navigator.clipboard.writeText(text).then(() => {
      const orig = btn.innerText; btn.innerText = 'Copied!';
      setTimeout(() => btn.innerText = orig, 2000);
    });
  }
</script>
</body>
</html>